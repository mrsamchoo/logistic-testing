{% extends "base.html" %}
{% block title %}Admin — สร้าง Shipment ใหม่{% endblock %}

{% block content %}
<div class="flex items-center justify-between mb-6">
    <div class="flex items-center gap-3">
        <a href="/admin/shipments" class="text-gray-400 hover:text-gray-600">&larr; กลับ</a>
        <h1 class="text-2xl font-bold text-gray-800">&#x1f4e6; สร้าง Shipment ใหม่</h1>
        {% if admin_role == 'super_admin' %}
            <span class="bg-red-100 text-red-700 px-2 py-0.5 rounded text-xs font-bold">Super Admin</span>
        {% else %}
            <span class="bg-blue-100 text-blue-700 px-2 py-0.5 rounded text-xs font-bold">Admin</span>
        {% endif %}
    </div>
    <a href="/admin/logout" class="text-sm text-gray-500 hover:text-red-500">ออกจากระบบ</a>
</div>

<div class="bg-white rounded-xl shadow-sm p-6">
    <form method="POST" action="/admin/shipments/create">
        <!-- Customer Selection -->
        <div class="mb-6">
            <h2 class="text-lg font-semibold text-gray-800 mb-3">&#x1f464; เลือกลูกค้า</h2>
            <select name="customer_code" id="customer-select" required onchange="loadAddresses()"
                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-500 text-lg">
                <option value="">-- เลือกลูกค้า --</option>
                {% for c in customers %}
                    <option value="{{ c.customer_code }}"
                        {% if request.args.get('customer') == c.customer_code %}selected{% endif %}
                        data-name="{{ c.sender_first_name }} {{ c.sender_last_name }}"
                        data-type="{{ c.location_type }}">
                        {{ c.customer_code }} ({{ c.sea_code }}) — {{ c.sender_first_name }} {{ c.sender_last_name }}
                        {% if c.location_type == 'us' %}[US]{% else %}[TH]{% endif %}
                    </option>
                {% endfor %}
            </select>
        </div>

        <!-- Shipment Details -->
        <div class="mb-6">
            <h2 class="text-lg font-semibold text-gray-800 mb-3">&#x1f4cb; รายละเอียดพัสดุ</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="md:col-span-2">
                    <label class="block text-sm font-medium text-gray-700 mb-1">รายละเอียด</label>
                    <input type="text" name="description" placeholder="เช่น กล่องเสื้อผ้า, อุปกรณ์อิเล็กทรอนิกส์"
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">น้ำหนัก</label>
                    <input type="text" name="weight" placeholder="เช่น 1.5 kg"
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Port</label>
                    <select name="port" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-500">
                        <option value="">-- ไม่ระบุ --</option>
                        {% for p in PORTS %}
                            <option value="{{ p }}">{{ p }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
        </div>

        <!-- Address Selection (dynamic) -->
        <div class="mb-6">
            <h2 class="text-lg font-semibold text-gray-800 mb-3">&#x1f4cd; ที่อยู่ปลายทาง</h2>
            <div id="address-container">
                <p class="text-gray-400 text-sm">กรุณาเลือกลูกค้าก่อน</p>
            </div>
            <input type="hidden" name="address_id" id="address-id-input" value="">
        </div>

        <div class="flex gap-3">
            <button type="submit" class="px-8 py-3 bg-yellow-500 text-white rounded-lg hover:bg-yellow-600 transition-colors font-bold text-lg">
                &#x2713; สร้าง Shipment
            </button>
            <a href="/admin/shipments" class="px-8 py-3 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-colors text-lg">
                ยกเลิก
            </a>
        </div>
    </form>
</div>

<!-- Address data embedded in page for JS -->
<script>
const addressData = {
    {% for c in customers %}
    "{{ c.customer_code }}": {{ c.id }},
    {% endfor %}
};

// Pre-load all addresses via a simple fetch
async function loadAddresses() {
    const select = document.getElementById('customer-select');
    const code = select.value;
    const container = document.getElementById('address-container');
    const hiddenInput = document.getElementById('address-id-input');
    hiddenInput.value = '';

    if (!code) {
        container.innerHTML = '<p class="text-gray-400 text-sm">กรุณาเลือกลูกค้าก่อน</p>';
        return;
    }

    // Fetch addresses from the customer detail page API
    try {
        const resp = await fetch('/admin/customer/' + code);
        const html = await resp.text();
        const parser = new DOMParser();
        const doc = parser.parseFromString(html, 'text/html');

        // Extract address data from the page
        const addressCards = doc.querySelectorAll('[class*="border-gray-200"][class*="rounded-lg"][class*="p-4"]');
        if (addressCards.length === 0) {
            container.innerHTML = '<p class="text-amber-600 text-sm">ลูกค้านี้ยังไม่มีที่อยู่ปลายทาง</p>';
            return;
        }

        // We'll use a simpler approach - just show a message
        container.innerHTML = '<p class="text-gray-500 text-sm">&#x2139;&#xfe0f; ที่อยู่ปลายทางจะถูกตั้งค่าในภายหลัง สามารถเลือกที่อยู่ได้จากหน้าจัดการพัสดุ</p>';
    } catch (e) {
        container.innerHTML = '<p class="text-gray-500 text-sm">&#x2139;&#xfe0f; ที่อยู่ปลายทางจะถูกตั้งค่าในภายหลัง สามารถเลือกที่อยู่ได้จากหน้าจัดการพัสดุ</p>';
    }
}

// Auto-load if customer is pre-selected
if (document.getElementById('customer-select').value) {
    loadAddresses();
}
</script>
{% endblock %}
